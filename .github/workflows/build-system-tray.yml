name: ÔøΩ Build NMEA Tracker Server - System Tray

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_version:
        description: 'Version to build'
        required: true
        default: 'system-tray'
        type: choice
        options:
          - 'system-tray'
          - 'all-components'

env:
  PYTHON_VERSION: '3.13'
  APP_NAME: 'NMEA-Tracker-Server'

jobs:
  build-windows:
    name: üñ•Ô∏è Build Windows System Tray
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller cryptography
        Write-Host "‚úÖ Dependencies installed successfully"
        
    - name: üîç Verify Dependencies
      run: |
        echo "=== Python Environment ==="
        python --version
        pip --version
        echo ""
        echo "=== Key Packages ==="
        pip show flask flask-socketio pyserial pystray pillow pyinstaller
        echo ""
        echo "=== Project Files ==="
        Get-ChildItem "nmea_server*.py" | Select-Object Name, Length
        Get-ChildItem "*.spec" | Select-Object Name, Length

    - name: üõ†Ô∏è Create SSL Certificates
      run: |
        echo "Creating SSL certificates for build..."
        python -c "
        from cryptography import x509
        from cryptography.hazmat.primitives import hashes, serialization
        from cryptography.hazmat.primitives.asymmetric import rsa
        from datetime import datetime, timedelta
        import ipaddress
        
        # Generate private key
        private_key = rsa.generate_private_key(
            public_exponent=65537,
            key_size=2048,
        )
        
        # Create certificate
        subject = issuer = x509.Name([
            x509.NameAttribute(x509.NameOID.COUNTRY_NAME, 'FR'),
            x509.NameAttribute(x509.NameOID.STATE_OR_PROVINCE_NAME, 'France'),
            x509.NameAttribute(x509.NameOID.LOCALITY_NAME, 'Local'),
            x509.NameAttribute(x509.NameOID.ORGANIZATION_NAME, 'NMEA Tracker'),
            x509.NameAttribute(x509.NameOID.COMMON_NAME, 'localhost'),
        ])
        
        cert = x509.CertificateBuilder().subject_name(
            subject
        ).issuer_name(
            issuer
        ).public_key(
            private_key.public_key()
        ).serial_number(
            x509.random_serial_number()
        ).not_valid_before(
            datetime.utcnow()
        ).not_valid_after(
            datetime.utcnow() + timedelta(days=365)
        ).add_extension(
            x509.SubjectAlternativeName([
                x509.DNSName('localhost'),
                x509.IPAddress(ipaddress.IPv4Address('127.0.0.1')),
            ]),
            critical=False,
        ).sign(private_key, hashes.SHA256())
        
        # Write certificate
        with open('cert.pem', 'wb') as f:
            f.write(cert.public_bytes(serialization.Encoding.PEM))
        
        # Write private key
        with open('key.pem', 'wb') as f:
            f.write(private_key.private_bytes(
                encoding=serialization.Encoding.PEM,
                format=serialization.PrivateFormat.PKCS8,
                encryption_algorithm=serialization.NoEncryption()
            ))
        
        print('SSL certificates created successfully')
        "
        
    - name: üéØ Build System Tray Version
      run: |
        echo "=== Building NMEA Tracker Server - System Tray ==="
        echo "Build started at: $(Get-Date)"
        
        # Create build directories
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        
        # Build with PyInstaller
        pyinstaller nmea_server_tray.spec --clean --noconfirm
        
        if (Test-Path "dist/nmea_server_tray.exe") {
            echo "‚úÖ System Tray build successful!"
            $size = (Get-Item "dist/nmea_server_tray.exe").Length
            echo "üìÅ File size: $([math]::Round($size/1MB, 2)) MB"
        } else {
            echo "‚ùå System Tray build failed!"
            Get-ChildItem "dist" -ErrorAction SilentlyContinue
            exit 1
        }

    - name: üîß Build Additional Components (if requested)
      if: ${{ github.event.inputs.build_version == 'all-components' || github.event.inputs.build_version == '' }}
      run: |
        echo "=== Building Additional Components ==="
        
        # Build Console Server
        echo "Building Console Server..."
        pyinstaller nmea_server.spec --clean --noconfirm
        if (Test-Path "dist/nmea_tracker_server.exe") {
            echo "‚úÖ Console Server build successful"
        }
        
        # Build Test Server
        echo "Building Test Server..."
        pyinstaller nmea_server_test.spec --clean --noconfirm
        if (Test-Path "dist/nmea_server_test.exe") {
            echo "‚úÖ Test Server build successful"
        }
        
        # Build Manager
        echo "Building Manager..."
        pyinstaller nmea_server_manager.spec --clean --noconfirm
        if (Test-Path "dist/nmea_server_manager.exe") {
            echo "‚úÖ Manager build successful"
        }

    - name: üîç Test System Tray Executable
      run: |
        echo "=== Testing System Tray Executable ==="
        cd dist
        
        # Basic validation - check if file exists and has reasonable size
        if (Test-Path "nmea_server_tray.exe") {
            $fileInfo = Get-Item "nmea_server_tray.exe"
            echo "File: $($fileInfo.Name)"
            echo "Size: $([math]::Round($fileInfo.Length/1MB, 2)) MB"
            echo "Created: $($fileInfo.CreationTime)"
            
            if ($fileInfo.Length -gt 10MB) {
                echo "‚úÖ File size looks reasonable"
            } else {
                echo "‚ö†Ô∏è Warning: File size seems small"
            }
        } else {
            echo "‚ùå Executable not found!"
            exit 1
        }

    - name: üìä Build Summary
      run: |
        echo "=== Build Summary ==="
        echo "Build completed at: $(Get-Date)"
        echo ""
        echo "Built executables:"
        if (Test-Path "dist") {
          Get-ChildItem "dist/*.exe" | ForEach-Object {
            $size = [math]::Round($_.Length/1MB, 2)
            echo "  ‚úÖ $($_.Name) - ${size} MB"
          }
        } else {
          echo "  ‚ùå No executables found"
        }
        echo ""
        echo "üéØ System Tray build process completed!"

    - name: ÔøΩ Upload System Tray Executable
      uses: actions/upload-artifact@v4
      with:
        name: nmea-server-tray-windows
        path: dist/nmea_server_tray.exe
        retention-days: 30

    - name: üì§ Upload All Executables (if built)
      if: ${{ github.event.inputs.build_version == 'all-components' || github.event.inputs.build_version == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: nmea-server-all-components-windows
        path: dist/*.exe
        retention-days: 30

    - name: üîß Upload Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-system-tray
        path: |
          build/
          *.log
        retention-days: 7

    - name: üìä Generate Build Info
      run: |
        echo "=== Build Information ==="
        $buildInfo = @{
            "build_date" = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
            "python_version" = python --version
            "git_commit" = git rev-parse HEAD
            "git_branch" = git rev-parse --abbrev-ref HEAD
            "build_type" = "system-tray"
            "platform" = "windows"
        }
        
        $buildInfo | ConvertTo-Json | Out-File -FilePath "dist/build_info.json" -Encoding UTF8
        
        # Create version info
        echo "NMEA Tracker Server - System Tray Version" | Out-File -FilePath "dist/VERSION.txt" -Encoding UTF8
        echo "Build: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath "dist/VERSION.txt" -Append -Encoding UTF8
        echo "Commit: $(git rev-parse --short HEAD)" | Out-File -FilePath "dist/VERSION.txt" -Append -Encoding UTF8

    - name: üìã Create Release Notes
      run: |
        echo "# NMEA Tracker Server - System Tray Release" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Encoding UTF8
        echo "" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "## Installation" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "1. Download nmea_server_tray.exe" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "2. Double-click to launch" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "3. The icon appears in the system tray" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "4. Right-click on the icon to access the menu" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "## Web Interface" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- Dashboard: https://localhost:8443/" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- Configuration: https://localhost:8443/config.html" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "## Features" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- Discrete interface (system tray)" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- NMEA GPS/AIS support" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- UDP/TCP/Serial connections" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- Complete web interface" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8
        echo "- Advanced AIS parsing with message fragments" | Out-File -FilePath "dist/RELEASE_NOTES.md" -Append -Encoding UTF8

    - name: üì§ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nmea-tracker-tray-windows
        path: |
          dist/nmea_server_tray.exe
          dist/build_info.json
          dist/VERSION.txt
          dist/RELEASE_NOTES.md
        retention-days: 30

    - name: üè∑Ô∏è Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/nmea_server_tray.exe
          dist/RELEASE_NOTES.md
        name: "NMEA Tracker Server ${{ github.ref_name }} - System Tray"
        body_path: dist/RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-all-versions:
    name: üéØ Build All Versions
    runs-on: windows-latest
    if: github.event.inputs.build_version == 'all' || startsWith(github.ref, 'refs/tags/')
    
    strategy:
      matrix:
        version: [
          { name: "console", spec: "nmea_server.spec", exe: "nmea_tracker_server.exe" },
          { name: "system-tray", spec: "nmea_server_tray.spec", exe: "nmea_server_tray.exe" },
          { name: "test", spec: "nmea_server_test.spec", exe: "nmea_server_test.exe" },
          { name: "manager", spec: "nmea_server_manager.spec", exe: "nmea_server_manager.exe" }
        ]
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install gevent first for Python 3.13 compatibility
        pip install gevent
        # Then install the rest
        pip install flask flask-socketio python-socketio pyserial python-dotenv cryptography flask-cors
        pip install pystray pillow pyinstaller
        Write-Host "‚úÖ Dependencies installed successfully (with gevent for Python 3.13)"

    - name: üõ†Ô∏è Create SSL Certificates
      run: |
        python -c "
        from cryptography import x509
        from cryptography.hazmat.primitives import hashes, serialization
        from cryptography.hazmat.primitives.asymmetric import rsa
        from datetime import datetime, timedelta
        import ipaddress
        
        private_key = rsa.generate_private_key(public_exponent=65537, key_size=2048)
        subject = issuer = x509.Name([x509.NameAttribute(x509.NameOID.COMMON_NAME, 'localhost')])
        cert = x509.CertificateBuilder().subject_name(subject).issuer_name(issuer).public_key(private_key.public_key()).serial_number(x509.random_serial_number()).not_valid_before(datetime.utcnow()).not_valid_after(datetime.utcnow() + timedelta(days=365)).sign(private_key, hashes.SHA256())
        
        with open('cert.pem', 'wb') as f: f.write(cert.public_bytes(serialization.Encoding.PEM))
        with open('key.pem', 'wb') as f: f.write(private_key.private_bytes(encoding=serialization.Encoding.PEM, format=serialization.PrivateFormat.PKCS8, encryption_algorithm=serialization.NoEncryption()))
        "

    - name: üèóÔ∏è Build ${{ matrix.version.name }}
      run: |
        echo "=== Building ${{ matrix.version.name }} version ==="
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        New-Item -ItemType Directory -Path "dist" -Force
        
        pyinstaller ${{ matrix.version.spec }} --clean --noconfirm
        
        if (Test-Path "dist/${{ matrix.version.exe }}") {
            echo "‚úÖ ${{ matrix.version.name }} build successful!"
        } else {
            echo "‚ùå ${{ matrix.version.name }} build failed!"
            exit 1
        }

    - name: üì§ Upload ${{ matrix.version.name }} Artifact
      uses: actions/upload-artifact@v4
      with:
        name: nmea-tracker-${{ matrix.version.name }}-windows
        path: dist/${{ matrix.version.exe }}
        retention-days: 30

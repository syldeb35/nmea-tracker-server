name: 🧪 Test Build NMEA Tracker Server

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'

jobs:
  test-build:
    name: 🔍 Test Build All Components
    runs-on: windows-latest
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller cryptography

    - name: 🔐 Generate Test Certificates
      run: |
        python -c "
        from cryptography import x509
        from cryptography.hazmat.primitives import hashes, serialization
        from cryptography.hazmat.primitives.asymmetric import rsa
        from datetime import datetime, timedelta
        
        private_key = rsa.generate_private_key(public_exponent=65537, key_size=2048)
        subject = issuer = x509.Name([x509.NameAttribute(x509.NameOID.COMMON_NAME, 'localhost')])
        cert = x509.CertificateBuilder().subject_name(subject).issuer_name(issuer).public_key(private_key.public_key()).serial_number(x509.random_serial_number()).not_valid_before(datetime.utcnow()).not_valid_after(datetime.utcnow() + timedelta(days=1)).sign(private_key, hashes.SHA256())
        
        with open('cert.pem', 'wb') as f: f.write(cert.public_bytes(serialization.Encoding.PEM))
        with open('key.pem', 'wb') as f: f.write(private_key.private_bytes(encoding=serialization.Encoding.PEM, format=serialization.PrivateFormat.PKCS8, encryption_algorithm=serialization.NoEncryption()))
        print('Test certificates created')
        "

    - name: 🏗️ Test Build NMEA Server Console
      run: |
        echo "Testing NMEA Server Console build..."
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        
        pyinstaller nmea_server.spec --clean --noconfirm
        
        if (Test-Path "dist/nmea_tracker_server.exe") {
            echo "✅ NMEA Server Console build successful"
            $size = (Get-Item "dist/nmea_tracker_server.exe").Length
            echo "File size: $([math]::Round($size/1MB, 2)) MB"
        } else {
            echo "❌ NMEA Server Console build failed"
            exit 1
        }

    - name: 🎯 Test Build System Tray
      run: |
        echo "Testing System Tray build..."
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        
        pyinstaller nmea_server_tray.spec --clean --noconfirm
        
        if (Test-Path "dist/nmea_server_tray.exe") {
            echo "✅ System Tray build successful"
            $size = (Get-Item "dist/nmea_server_tray.exe").Length
            echo "File size: $([math]::Round($size/1MB, 2)) MB"
        } else {
            echo "❌ System Tray build failed"
            exit 1
        }

    - name: 🧪 Test Build Test Server
      run: |
        echo "Testing Test Server build..."
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        
        pyinstaller nmea_server.spec --clean --noconfirm
        
        if (Test-Path "dist/nmea_server.exe") {
            echo "✅ Test Server build successful"
            $size = (Get-Item "dist/nmea_server.exe").Length
            echo "File size: $([math]::Round($size/1MB, 2)) MB"
        } else {
            echo "❌ Test Server build failed"
            exit 1
        }

    - name: 🔧 Test Build Server Manager
      run: |
        echo "Testing Server Manager build..."
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        
        pyinstaller nmea_server_manager.spec --clean --noconfirm
        
        if (Test-Path "dist/nmea_server_manager.exe") {
            echo "✅ Server Manager build successful"
            $size = (Get-Item "dist/nmea_server_manager.exe").Length
            echo "File size: $([math]::Round($size/1MB, 2)) MB"
        } else {
            echo "❌ Server Manager build failed"
            exit 1
        }

    - name: 📊 Report
      run: |
        echo "=== Build Test Report ==="
        echo "✅ Dependencies installed successfully"
        echo "✅ SSL certificates generated"
        echo "✅ NMEA Server Console executable built and tested"
        echo "✅ System Tray executable built and tested"
        echo "✅ Test Server executable built and tested"
        echo "✅ Server Manager executable built and tested"
        echo ""
        echo "🎉 All components ready for production build!"

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>NMEA Connection Setup</title>
        <link rel="icon" type="image/svg+xml" href="favicon.svg">
        <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZDEiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMTk3NmQyO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxMjU2YTM7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNSIgZmlsbD0idXJsKCNncmFkMSkiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgPHBhdGggZD0iTTE2IDYgTDIwIDE0IEwxNiAxMiBMMTIgMTQgWiIgZmlsbD0iI2ZmZiIvPgogIDxwYXRoIGQ9Ik08IDE4IEwyNCAxOCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgogIDxwYXRoIGQ9Ik0xMCAyMiBMMjIgMjIiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgogIDxjaXJjbGUgY3g9IjE2IiBjeT0iMjYiIHI9IjEuNSIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4K">
        <style>
            body {
                font-family: 'Segoe UI', Arial, sans-serif;
                background: #f6faff;
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: 1100px;
                margin: 40px auto;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 12px #0001;
                padding: 32px 28px 24px 28px;
            }
            .config-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 32px;
            }
            @media (max-width: 900px) {
                .config-grid {
                    grid-template-columns: 1fr;
                }
            }
            h2 {
                color: #1976d2;
                margin-top: 0;
            }
            form label {
                display: block;
                margin: 14px 0 6px 0;
                font-weight: 500;
            }
            input[type="text"], input[type="number"], select {
                padding: 6px 10px;
                border: 1px solid #b0bec5;
                border-radius: 5px;
                font-size: 1em;
                margin-top: 4px;
                width: 100%;
                box-sizing: border-box;
            }
            input[type="checkbox"] {
                margin-right: 8px;
            }
            button[type="submit"] {
                background: #1976d2;
                color: #fff;
                border: none;
                border-radius: 6px;
                padding: 10px 28px;
                font-size: 1.1em;
                margin-top: 18px;
                cursor: pointer;
                transition: background 0.2s;
            }
            button[type="submit"]:hover {
                background: #1256a3;
            }
            hr {
                border: none;
                border-top: 1px solid #e0e0e0;
                margin: 24px 0;
            }
            .info-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .info-list li {
                margin-bottom: 6px;
                font-size: 1em;
            }
            .section-title {
                margin-bottom: 8px;
                color: #333;
                font-size: 1.1em;
                font-weight: 600;
            }
            .connection-status {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                border: 1px solid #dee2e6;
            }

            .status-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px 0;
                border-bottom: 1px solid #e9ecef;
            }

            .status-row:last-child {
                border-bottom: none;
            }

            .data-display {
                background: #000;
                color: #0f0;
                font-family: 'Courier New', monospace;
                padding: 10px;
                border-radius: 5px;
                height: 200px;
                overflow-y: auto;
                font-size: 12px;
            }

            .data-display div {
                margin: 2px 0;
            }
        </style>
    </head>
    <body>

        <div class="container">
            <h2>NMEA / AIS Connection</h2>
            <form id="configForm" method="POST" action="/select_connection">
                <div class="config-grid">
                    <div style="flex: 1 1 260px; min-width: 240px;">
                        <div class="section-title">Connection type:</div>
                        <p>Choose the connection(s) type(s) you want to enable:</p>
                        <label><input type="checkbox" name="enable_serial" {% if enable_serial %}checked{% endif %}>Serial</label>
                        <label><input type="checkbox" name="enable_udp" {% if enable_udp %}checked{% endif %}>UDP</label>
                        <label><input type="checkbox" name="enable_tcp" {% if enable_tcp %}checked{% endif %}>TCP</label>
                        <label><input type="checkbox" name="enable_debug" {% if enable_debug %}checked{% endif %}>Enable logging (DEBUG)</label>
                        <hr>
                        <div class="section-title">Serial settings:</div>
                        <p>Configure the serial settings for the connection:</p>
                        <label>Serial port:
                            <select name="serial_port">
                                <option value="AUTO" {% if serial_port == "AUTO" %}selected{% endif %}>
                                    AUTO - Bluetooth GPS Auto-Discovery (Linux only)
                                </option>
                                {% for port, desc in serial_ports %}
                                    <option value="{{ port }}" {% if port == serial_port %}selected{% endif %}>
                                        {{ port }}{% if desc %} ({{ desc }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </label>
                        <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 0.9em;">
                            <strong>🔵 AUTO Mode (Linux):</strong> Automatically scans for Bluetooth GPS devices every minute.
                            <br>• Automatically discovers GPS devices via Bluetooth scan
                            <br>• Creates rfcomm connection automatically (requires sudo permissions)
                            <br>• Reconnects automatically if connection is lost
                            <br>• No manual sdptool/rfcomm commands needed
                        </div>
                        <label>Baud rate:
                            <select name="serial_baudrate">
                                {% for br in [4800, 9600, 19200, 38400, 57600, 115200] %}
                                    <option value="{{ br }}" {% if br == serial_baudrate %}selected{% endif %}>{{ br }}</option>
                                {% endfor %}
                            </select>
                        </label>
                    </div>
                    <div style="flex: 1 1 260px; min-width: 240px;">
                        <div class="section-title">Network settings:</div>
                        <p>Configure the network settings for the connection:</p>
                        <!-- UDP Configuration -->
                        <div style="background: #f0f8ff; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>📡 UDP Configuration</h4>
                            <label><input type="radio" name="udp_mode" value="server" {% if udp_mode == "server" %}checked{% endif %}> 
                                📥 Server Mode (listen on a port)
                            </label>
                            <div id="udp-server-config" style="margin-left: 20px; margin: 10px 0; {% if udp_mode != 'server' %}display:none;{% endif %}">
                                <label>UDP listening port:
                                    <input type="number" name="udp_port" value="{{ udp_port }}" placeholder="50110">
                                </label>
                                <small>The server listens on this port to receive NMEA data</small>
                            </div>
                            <label><input type="radio" name="udp_mode" value="client" {% if udp_mode == "client" %}checked{% endif %}> 
                                📤 Mode Client (se connecte à un GPS)
                            </label>
                            <div id="udp-client-config" style="margin-left: 20px; margin: 10px 0; {% if udp_mode != 'client' %}display:none;{% endif %}">
                                <label>IP du GPS:
                                    <input type="text" name="udp_target_ip" value="{{ udp_target_ip }}" placeholder="192.168.1.100">
                                </label>
                                <label>Port du GPS:
                                    <input type="number" name="udp_target_port" value="{{ udp_target_port }}" placeholder="50110">
                                </label>
                                <small>Connects directly to GPS to receive data</small>
                            </div>
                        </div>
                        <!-- TCP Configuration -->
                        <div style="background: #fff0f0; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>🔗 TCP Configuration</h4>
                            <label><input type="radio" name="tcp_mode" value="server" {% if tcp_mode == "server" %}checked{% endif %}> 
                                📥 Server Mode (listen on a port)
                            </label>
                            <div id="tcp-server-config" style="margin-left: 20px; margin: 10px 0; {% if tcp_mode != 'server' %}display:none;{% endif %}">
                                <label>TCP listening port:
                                    <input type="number" name="tcp_port" value="{{ tcp_port }}" placeholder="7777">
                                </label>
                                <small>The server listens on this port to receive connections</small>
                            </div>
                            <label><input type="radio" name="tcp_mode" value="client" {% if tcp_mode == "client" %}checked{% endif %}> 
                                📤 Mode Client (se connecte à un GPS)
                            </label>
                            <div id="tcp-client-config" style="margin-left: 20px; margin: 10px 0; {% if tcp_mode != 'client' %}display:none;{% endif %}">
                                <label>IP du GPS:
                                    <input type="text" name="tcp_target_ip" value="{{ tcp_target_ip }}" placeholder="192.168.1.100">
                                </label>
                                <label>Port du GPS:
                                    <input type="number" name="tcp_target_port" value="{{ tcp_target_port }}" placeholder="50110">
                                </label>
                                <small>Se connecte directement au GPS via TCP</small>
                            </div>
                        </div>
                        <!-- MarineTraffic Configuration -->
                        <div style="background: #f8fff0; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>🌊 MarineTraffic Forwarding</h4>
                            <label>MarineTraffic IP:
                                <input type="text" name="marinetraffic__ip" value="{{ marinetraffic__ip }}" placeholder="5.9.207.224">
                            </label>
                            <label>MarineTraffic Port:
                                <input type="number" name="marinetraffic_port" value="{{ marinetraffic_port }}" placeholder="12435">
                            </label>
                            <label>MarineTraffic ID:
                                <input type="text" name="marinetraffic_id" value="{{ marinetraffic_id }}" placeholder="Leave blank to not forward to MarineTraffic">
                            </label>
                            <small>Configure the MarineTraffic account for AIS forwarding.</small>
                        </div>
                    </div>
                </div>
                <button type="submit" onclick="event.preventDefault(); applyConfig();">Apply</button>
            </form>

                <script>
                    // Manage configuration display according to mode
                    document.querySelectorAll('input[name="udp_mode"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            const isClient = this.value === 'client';
                            document.getElementById('udp-server-config').style.display = isClient ? 'none' : 'block';
                            document.getElementById('udp-client-config').style.display = isClient ? 'block' : 'none';
                        });
                    });

                    document.querySelectorAll('input[name="tcp_mode"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            const isClient = this.value === 'client';
                            document.getElementById('tcp-server-config').style.display = isClient ? 'none' : 'block';
                            document.getElementById('tcp-client-config').style.display = isClient ? 'block' : 'none';
                        });
                    });
                </script>
            </form>
            <hr>
            <div class="row mt-4">
                <div class="col-12">
                    <h4>🔌 Connection Status</h4>
                    <div class="connection-status">
                        <div class="status-row">
                            <span>Serial Connection:</span>
                            <span id="serial-status" class="status-indicator">🔴 Disconnected</span>
                        </div>
                        <div class="status-row">
                            <span>UDP Server:</span>
                            <span id="udp-status" class="status-indicator">🔴 Disconnected</span>
                        </div>
                        <div class="status-row">
                            <span>TCP Server:</span>
                            <span id="tcp-status" class="status-indicator">🔴 Disconnected</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <h4>📊 Real-time Data</h4>
                    <div id="nmea-data" class="data-display">
                        <div>Waiting for NMEA data...</div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <script>
        // WebSocket configuration
        const socket = io();
        let isConnected = false;

        // WebSocket connection
        socket.on('connect', function() {
            console.log('WebSocket connecté');
            isConnected = true;
            updateConnectionIndicator(true);
            
            // Demander le statut immédiatement
            socket.emit('request_status');
        });

        socket.on('disconnect', function() {
            console.log('WebSocket déconnecté');
            isConnected = false;
            updateConnectionIndicator(false);
        });

        // Real-time NMEA data reception (event with source)
        socket.on('nmea_data_web', function(data) {
            // Data already contains { source, message, timestamp }
            const webData = {
                source: data.source,
                message: data.message,
                timestamp: data.timestamp,
                formatted: `[${data.timestamp}][${data.source}] ${data.message}`
            };
            updateNMEADisplay(webData);
        });

        // Receiving status updates
        socket.on('status_update', function(status) {
            updateConnectionStatus(status);
        });

        function updateConnectionIndicator(connected) {
            const indicator = document.getElementById('websocket-status') || createWebSocketIndicator();
            indicator.className = connected ? 'status-indicator active' : 'status-indicator';
            indicator.textContent = connected ? '🟢 WebSocket connecté' : '🔴 WebSocket déconnecté';
        }

        function createWebSocketIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'websocket-status';
            indicator.className = 'status-indicator';
            const statusSection = document.querySelector('.connection-status');
            if (statusSection) {
                const row = document.createElement('div');
                row.className = 'status-row';
                row.innerHTML = '<span>WebSocket:</span>';
                row.appendChild(indicator);
                statusSection.appendChild(row);
            }
            return indicator;
        }

        function updateNMEADisplay(data) {
            const display = document.getElementById('nmea-data');
            if (!display) return;
            
            // Créer une nouvelle ligne
            const line = document.createElement('div');
            line.textContent = data.formatted || `[${data.timestamp}][${data.source}] ${data.message}`;
            
            // Ajouter la couleur selon la source
            switch(data.source) {
                case 'SERIAL':
                    line.style.color = '#0f0'; // Vert
                    break;
                case 'UDP':
                    line.style.color = '#ff0'; // Jaune
                    break;
                case 'TCP':
                    line.style.color = '#0ff'; // Cyan
                    break;
                default:
                    line.style.color = '#888'; // Gray for history
            }
            
            // Ajouter au début de l'affichage
            display.insertBefore(line, display.firstChild);
            
            // Keep only the last 100 lines
            while (display.children.length > 100) {
                display.removeChild(display.lastChild);
            }
            
            // Auto-scroll to top to see new data
            if (display.children.length === 1) {
                display.scrollTop = 0;
            }
        }

        // Update on input changes
        document.querySelectorAll('input[name="udp_mode"], input[name="tcp_mode"], input[name="udp_port"], input[name="tcp_port"], input[name="udp_target_ip"], input[name="udp_target_port"], input[name="tcp_target_ip"], input[name="tcp_target_port"]').forEach(el => {
            el.addEventListener('change', function() {
                // Handle change event
            });
            el.addEventListener('input', function() {
                // Optionally, you can add live validation or feedback here
            });
        });

        // Function to update connection status
        // This function will be called by the server via WebSocket
        function updateConnectionStatus(status) {
            console.log('Status update:', status);
            
            // Update indicators
            const indicators = {
                'serial-status': status.serial_connected,
                'udp-status': status.udp_active,
                'tcp-status': status.tcp_active
            };
            
            for (const [id, active] of Object.entries(indicators)) {
                const element = document.getElementById(id);
                if (element) {
                    element.className = active ? 'status-indicator active' : 'status-indicator';
                    element.textContent = active ? '🟢 Connecté' : '🔴 Déconnecté';
                }
            }
            
            // Update connection counter
            const activeCount = status.connections_active || 0;
            const countElement = document.getElementById('connection-count') || createConnectionCounter();
            countElement.textContent = `${activeCount} active connection(s)`;
        }

        function createConnectionCounter() {
            const counter = document.createElement('div');
            counter.id = 'connection-count';
            counter.style.fontWeight = 'bold';
            counter.style.textAlign = 'center';
            counter.style.marginTop = '10px';
            
            const statusSection = document.querySelector('.connection-status');
            if (statusSection) {
                statusSection.appendChild(counter);
            }
            return counter;
        }

        // Charger l'historique NMEA au démarrage
        async function loadNMEAHistory() {
            try {
                const response = await fetch('/api/nmea_history');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const display = document.getElementById('nmea-data');
                    display.innerHTML = ''; // Vider
                    
                    result.data.forEach(line => {
                        updateNMEADisplay({
                            source: 'HISTORY',
                            message: line,
                            timestamp: '',
                            formatted: line
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Request status every 5 seconds
        setInterval(() => {
            if (isConnected) {
                socket.emit('request_status');
            } else {
                // Essayer de recharger le statut via API REST
                checkServerStatus();
            }
        }, 5000);

        // Charger l'historique au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadNMEAHistory();
            
            // Add initial message
            setTimeout(() => {
                if (document.getElementById('nmea-data').children.length === 0) {
                    updateNMEADisplay({
                        source: 'SYSTEM',
                        message: 'Waiting for NMEA data...',
                        timestamp: new Date().toLocaleTimeString(),
                        formatted: '[SYSTEM] Waiting for NMEA data...'
                    });
                }
            }, 1000);
        });

        // 
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                updateConnectionStatus(status);
                
                if (status.connections_active > 0) {
                    showStatus('✅ Server active with new configurations!', 'success');
                } else {
                    showStatus('⚠️ Configuration applied but no active connection', 'warning');
                }
                
            } catch (error) {
                showStatus('⚠️ Unable to verify server status', 'warning');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status') || createStatusDiv();
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function createStatusDiv() {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'status';
            statusDiv.style.marginTop = '10px';
            document.querySelector('.container').appendChild(statusDiv);
            return statusDiv;
        }

        // Améliorer la fonction applyConfig
        async function applyConfig() {
            const formData = new FormData(document.getElementById('configForm'));
            
            try {
                showStatus('Applying configuration...', 'info');
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('✅ Configuration applied! Restarting connections...', 'success');
                    
                    // Demander le nouveau statut après 2 secondes
                    setTimeout(() => {
                        if (isConnected) {
                            socket.emit('request_status');
                        } else {
                            checkServerStatus();
                        }
                    }, 2000);
                    
                } else {
                    showStatus('❌ Error: ' + result.error, 'error');
                }
                
            } catch (error) {
                showStatus('❌ Network error: ' + error.message, 'error');
            }
        }

        // CSS amélioré
        const advancedStyle = document.createElement('style');
        advancedStyle.textContent = `
        .data-display {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-size: 11px;
            border: 1px solid #333;
        }

        .data-display div {
            margin: 1px 0;
            padding: 1px 0;
            border-bottom: 1px solid #111;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
            font-size: 12px;
        }

        .status-indicator.active {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-indicator:not(.active) {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-row:last-child {
            border-bottom: none;
        }

        #connection-count {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        `;
        document.head.appendChild(advancedStyle);

        // Ajouter styles pour les alertes
        const alertStyle = document.createElement('style');
        alertStyle.textContent = `
        .alert {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #b6d4db;
            color: #0c5460;
        }
        `;
        document.head.appendChild(alertStyle);
        </script>
    </body>
</html>